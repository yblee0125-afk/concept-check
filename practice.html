<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConceptCheck AI — 문제 풀이</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>ConceptCheck AI</h1>
        <div class="sub">문제 풀이 페이지 · 선택한 개념을 자신의 말로 설명해보세요</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" id="btnBack">← 개념 설명</button>
      <button class="btn" id="btnReset">초기화</button>
    </div>
  </header>

  <div class="grid">
    <!-- Left (1.2fr) -->
    <section class="card">
      <div class="hd">
        <div>
          <p class="title">서술형 답변 작성</p>
          <div class="desc">학생은 ‘기준 정의’를 보지 않고, 개념을 자신의 말로 설명합니다.</div>
        </div>
        <div class="split">
          <button class="btn primary" id="btnAnalyze">진단 실행</button>
        </div>
      </div>

      <div class="bd">
        <div class="twocol">
          <div class="row">
            <label>선택 개념</label>
            <input id="conceptTitle" disabled />
          </div>
          <div class="row">
            <label>난이도</label>
            <input id="levelText" disabled />
          </div>
        </div>

        <!-- ✅ 기준 정의 UI 삭제 -->

        <div class="row">
          <label>학습자 서술형 답변</label>
          <textarea id="answer" placeholder="선택한 개념을 자신의 말로 설명해보세요. (1~3문장 권장)"></textarea>
          <div class="small muted">예: “광합성은 식물이 빛을 이용해 …”</div>
        </div>

        <div class="split">
          <button class="btn" id="btnExample">오답 예시 넣기</button>
          <span class="small muted">기준 정의는 내부 저장값을 사용합니다(학생 화면에는 비표시).</span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <label>진단 프롬프트(요약 미리보기)</label>
          <pre id="promptPreview"></pre>
          <div class="small muted" style="margin-top:6px;">
            * 프롬프트에는 기준 정의가 포함되지만, 화면에는 표시하지 않습니다.
          </div>
        </div>
      </div>
    </section>

    <!-- Right (0.8fr) -->
    <aside class="card">
      <div class="hd">
        <div>
          <p class="title">진단 결과</p>
          <div class="desc">요약 · 오개념 · 피드백 · 후속 질문</div>
        </div>
        <div class="split">
          <button class="btn" id="btnCopyJson">JSON 복사</button>
          <button class="btn" id="btnExport">결과 저장(.json)</button>
        </div>
      </div>

      <div class="bd">
        <div id="resultBox" class="item" style="display:none;"></div>

        <!-- ✅ 결과 JSON 숨김(기능 유지) -->
        <pre id="resultJson" style="display:none;">{}</pre>

        <div class="hr"></div>

        <div class="small muted">
          * Demo 모드는 저장된 기준 정의와의 키워드 유사도를 기반으로 “정답(유사키워드 충분)”만 정답 처리합니다.
        </div>
      </div>
    </aside>
  </div>
</div>

<script type="module">
  import { loadState, nowStamp, safeJson, demoDiagnose, escapeHtml, levelLabel } from "./app.js";

  const $ = (id)=>document.getElementById(id);

  function buildPromptPreview(concept, goldHidden, answer, level){
    const sys = [
      "너는 교육용 AI 튜터이자 '개념 진단' 평가자이다.",
      "목표는 학습자의 서술형 답변을 분석하여 개념 이해 여부와 오개념을 진단하고,",
      "친절하고 단계적으로 피드백을 제공하는 것이다.",
      "반드시 JSON 스키마 형태로 출력하라."
    ].join("\\n");

    const user = [
      `[학습 수준]`,
      levelLabel(level),
      "",
      `[학습 개념]`,
      concept,
      "",
      `[정확한 개념 설명(기준)]`,
      goldHidden,  // ✅ 내부 저장된 기준 정의(학생 UI에는 미표시)
      "",
      `[학습자 답변]`,
      answer
    ].join("\\n");

    return `SYSTEM\\n${sys}\\n\\nUSER\\n${user}`;
  }

  function updatePrompt(){
    const st = loadState();
    if(!st) return;
    const goldHidden = (st.gold_definition || "").trim();
    $("promptPreview").textContent = buildPromptPreview(
      st.concept || "-",
      goldHidden || "(기준 정의 없음)",
      $("answer").value.trim(),
      st.level || "middle"
    );
  }

  function renderResult(result){
    $("resultJson").textContent = safeJson(result);

    const badgeClass =
      result.understanding_level==="high" ? "good" :
      result.understanding_level==="medium" ? "warn" : "bad";

    $("resultBox").style.display = "block";
    $("resultBox").innerHTML = `
      <div class="split">
        <div>
          <div style="font-size:13px;font-weight:700;">요약</div>
          <div class="small muted">${escapeHtml(result.student_summary)}</div>
        </div>
        <span class="badge ${badgeClass}">${result.understanding_level.toUpperCase()} · ${result.is_correct ? "Correct" : "Needs Fix"}</span>
      </div>

      <div class="hr"></div>

      <div style="font-size:13px;font-weight:700;">오개념 진단</div>
      <div class="small muted" style="margin-top:6px;">
        ${
          (result.misconceptions && result.misconceptions.length)
          ? result.misconceptions.map(m=>`
            <div style="margin-bottom:10px;">
              <span class="badge">${escapeHtml(m.type)}</span>
              <div style="margin-top:6px;">• ${escapeHtml(m.issue)}</div>
              <div class="small muted">근거: ${escapeHtml(m.evidence)}</div>
            </div>
          `).join("")
          : `<div class="muted">오개념이 뚜렷하게 발견되지 않았어요.</div>`
        }
      </div>

      <div class="hr"></div>

      <div style="font-size:13px;font-weight:700;">맞춤 피드백</div>
      <pre style="margin-top:8px;white-space:pre-wrap;">${escapeHtml(result.feedback || "")}</pre>

      <div class="hr"></div>

      <div style="font-size:13px;font-weight:700;">후속 질문</div>
      <div class="small muted" style="margin-top:6px;">
        ${(result.next_questions||[]).map(q=>`<div>• ${escapeHtml(q)}</div>`).join("")}
      </div>
    `;
  }

  // init state
  const st = loadState();
  if(!st || !st.concept){
    $("conceptTitle").value = "먼저 개념 설명 페이지에서 개념을 선택하세요";
    $("levelText").value = "-";
  }else{
    $("conceptTitle").value = st.concept || "-";
    $("levelText").value = levelLabel(st.level || "middle");
  }
  updatePrompt();

  $("answer").addEventListener("input", updatePrompt);

  $("btnAnalyze").addEventListener("click", ()=>{
    const st = loadState();
    if(!st || !st.concept){
      alert("먼저 개념 설명 페이지에서 개념을 선택해주세요.");
      return;
    }
    const goldHidden = (st.gold_definition || "").trim();
    const ans = $("answer").value.trim();

    if(!goldHidden){
      alert("기준 정의가 없습니다. 개념 설명 페이지에서 기준 정의를 작성해주세요.");
      return;
    }
    if(!ans){
      alert("답변을 입력해주세요.");
      return;
    }

    const result = demoDiagnose(st.concept, goldHidden, ans);
    renderResult(result);
  });

  $("btnExample").addEventListener("click", ()=>{
    $("answer").value = "니가 설명해봐라";
    updatePrompt();
  });

  $("btnCopyJson").addEventListener("click", async ()=>{
    await navigator.clipboard.writeText($("resultJson").textContent);
    alert("결과 JSON을 복사했어요.");
  });

  $("btnExport").addEventListener("click", ()=>{
    const st = loadState();
    const raw = $("resultJson").textContent.trim();
    if(!raw || raw==="{}"){
      alert("저장할 결과가 없습니다.");
      return;
    }
    const blob = new Blob([raw], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `conceptcheck_result_${(st?.concept||"concept")}_${nowStamp().replace(/[^\d]/g,"")}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("btnBack").addEventListener("click", ()=> location.href = "./index.html");
  $("btnReset").addEventListener("click", ()=>{
    $("answer").value = "";
    $("resultBox").style.display = "none";
    $("resultJson").textContent = "{}";
    updatePrompt();
  });
</script>
</body>
</html>
